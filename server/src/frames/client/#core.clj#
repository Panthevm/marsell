(ns frames.client.core
  "TODO refactor"
  (:require
   [frames.server.request :as request]
   [frames.server.response :as response]
   [clojure.java.io       :as io])
  (:import
   [java.net InetAddress URL Socket]))


(defn make
  [writer params]
  (let [body (some-> params :body str)
        bytes-reponse
        (.getBytes
         (str (:method params) " " (or (:path params) "/") " HTTP/1.1\n" 
              (response/make-headers (:headers params) body)
              "\r\n"
              body))]
    (.write writer bytes-reponse 0 (alength bytes-reponse))
    (.flush writer)))

(defn parse
  [reader]
  (let [[version status message] (re-seq #"[^ ]+" (.readLine reader))
        headers                  (request/read-headers reader)
        body                     (some-> (:Content-Length headers) (request/read-body reader))]
    {:status       status
     :message      message
     :version      version
     :headers      headers
     :body         body}))

(defn request
  [params]
  (let [[address path] (re-seq #"[^/]+" (:url params))]
    (.getLocalPort (InetAddress/getByName "localhost"))
    (with-open [socket (Socket. address (.getLocalPort (URL. "http://localhost")))
                writer (io/output-stream socket)
                reader (io/reader socket)]
      (make writer (assoc params :path path))
      (parse reader))))
